var uri="ws://"+location.hostname+"/ws";var ws_opened=!1;var pingPongTimer=null;var callbackMessage=null;const webSocket=new ReconnectingWebSocket(uri,null,{debug:!0,binaryType:"arraybuffer"});const checkConnection=()=>{setTimeout(()=>{if(null!=webSocket&&ws_opened){webSocket.send("ping")} pingPongTimer=setTimeout(()=>{console.warn('try to reconnect...');pingPongTimer=null;webSocket.refresh()},1000)},4000)};webSocket.onopen=()=>{console.info('socket is opened : ',new Date());ws_opened=!0;checkConnection()};webSocket.onmessage=(event)=>{if('pong'===event.data){clearTimeout(pingPongTimer);return checkConnection()}else if(event.data.constructor===ArrayBuffer){var arr=new Uint8Array(event.data);if(callbackMessage){callbackMessage(arr)}}else{console.warn(event)}};export const setCallbackMessage=(newCallback)=>{callbackMessage=newCallback};export const sendWebSocketDataHex=(hexStrings)=>{if(null!=webSocket&&ws_opened){const hexNumbers=hexStrings.map((hex)=>Number('0x'+hex));const u8=new Uint8Array(hexNumbers);sendWebSocketData(u8)}};export const sendWebSocketData=(data)=>{if(null!=webSocket&&ws_opened){webSocket.send(data)}};var duty_slider=document.getElementById('out-duty');noUiSlider.create(duty_slider,{start:[0],connect:!0,direction:'rtl',orientation:'vertical',behaviour:'tap',range:{'min':0,'max':100},pips:{mode:'count',values:6,density:5}});var bytes_pre=new Uint8Array(4);var mode;var dir=0;var xctrl=!1;var aliveTimer=null;const parseSokeck=(bytes)=>{if(0x04==bytes[0]){resetAliveTimer();if(bytes_pre[1]!=bytes[1]){mode=bytes[1]&0x0F;dir=(bytes[1]&0x30)>>4;switch(dir){case 1:document.getElementById("out-fwd").style.fill='green';document.getElementById("out-rvs").style.fill='currentColor';break;case 2:document.getElementById("out-fwd").style.fill='currentColor';document.getElementById("out-rvs").style.fill='green';break;default:document.getElementById("out-fwd").style.fill='currentColor';document.getElementById("out-rvs").style.fill='currentColor'}} bytes_pre[1]=bytes[1];if(bytes[2]&0x01){if(!1==xctrl){xctrl=!0;console.info("external control is enable.");const xctrlTImer=setInterval(()=>{if(xctrl){console.count("update_speed");update_speed()}else{console.countReset("update_speed");clearInterval(xctrlTImer)}},200)}}else{if(xctrl){xctrl=!1;console.info("external control is disable.")}} if(bytes[2]&0x80){document.getElementById("state-mcu").style.color='red'}else{document.getElementById("state-mcu").style.color='green'} if(bytes[2]&0x20){document.getElementById("state-out").style.color='red'}else if(2==mode){document.getElementById("state-out").style.color='green'}else{document.getElementById("state-out").style.color='currentColor'} var volInput=bytes[3]*0.1;if(10>volInput){document.getElementById("volt-in").textContent='!'+volInput.toFixed(1)}else{document.getElementById("volt-in").textContent=volInput.toFixed(1)} var tempCpu=bytes[4]-128;if(-10>=tempCpu){document.getElementById("temp-cpu").textContent='-'+tempCpu}else if(0>tempCpu){document.getElementById("temp-cpu").textContent='!-'+tempCpu}else if(10>tempCpu){document.getElementById("temp-cpu").textContent='!!'+tempCpu}else if(100>tempCpu){document.getElementById("temp-cpu").textContent='!'+tempCpu}else{document.getElementById("temp-cpu").textContent=tempCpu}}else{console.warn("unknown data ... ",bytes)}};setCallbackMessage(parseSokeck);const resetAliveTimer=()=>{clearTimeout(aliveTimer);aliveTimer=setTimeout(()=>{document.getElementById("out-fwd").style.fill='currentColor';document.getElementById("out-rvs").style.fill='currentColor';document.getElementById("state-mcu").style.color='currentColor';document.getElementById("state-out").style.color='currentColor';document.getElementById("volt-in").textContent='--.-';document.getElementById("temp-cpu").textContent='---';duty_slider.noUiSlider.set(0);dir=0},1000)};function sendOutputCmd(duty){var duty0,duty1;if(dir){if(duty>4095){duty=4095} duty0=duty&0x00FF;duty1=(duty&0x3F00)>>8;if(1==dir){duty1=duty1+64}else if(2==dir){duty1=duty1+128} const ar_cmd=new Uint8Array(3);ar_cmd[0]=parseInt('12',16);ar_cmd[1]=duty0;ar_cmd[2]=duty1;sendWebSocketData(ar_cmd)}} function update_speed(){if(dir){var duty=Math.floor(duty_slider.noUiSlider.get()*4096/100);sendOutputCmd(duty)}} export const OutputOn=(direction)=>{if(direction>2){dir=0}else{dir=direction;sendOutputCmd(0)}};export const OutputStop=()=>{duty_slider.noUiSlider.set(0)};export const OutputOff=()=>{dir=0;duty_slider.noUiSlider.set(0);const ar_cmd=new Uint8Array(3);ar_cmd[0]=parseInt('12',16);ar_cmd[1]=parseInt('00',16);ar_cmd[2]=parseInt('00',16);sendWebSocketData(ar_cmd)}